#!/bin/bash

# Fetch the current table as JSON
curl 'https://commons.wikimedia.org/wiki/Data:COVID-19_cases_in_San_Mateo_County,_California.tab?action=raw' > commons.json

# Fetch the new cases by day from the dashboard
# Convert date from number of milliseconds to YYYY-MM-DD
# Join new cases to cumulative cases
# Fill in counts repeated from previous days, which are indicated by C = null, R = 2
curl 'https://wabi-us-gov-iowa-api.analysis.usgovcloudapi.net/public/reports/querydata' --compressed --data '{"version":"1.0.0","queries":[{"Query":{"Commands":[{"SemanticQueryDataShapeCommand":{"Query":{"Version":2,"From":[{"Name":"c","Entity":"cases_by_day","Type":0}],"Select":[{"Column":{"Expression":{"SourceRef":{"Source":"c"}},"Property":"date_result"},"Name":"cases_by_day.date_result"},{"Aggregation":{"Expression":{"Column":{"Expression":{"SourceRef":{"Source":"c"}},"Property":"n"}},"Function":0},"Name":"CountNonNull(cases_by_day.n)"}],"Where":[{"Condition":{"In":{"Expressions":[{"Column":{"Expression":{"SourceRef":{"Source":"c"}},"Property":"yesterday_or_before"}}],"Values":[[{"Literal":{"Value":"1L"}}],[{"Literal":{"Value":"0L"}}]]}}}]},"Binding":{"Primary":{"Groupings":[{"Projections":[0,1]}]},"DataReduction":{"DataVolume":4,"Primary":{"Sample":{}}},"Version":1}}}]},"CacheKey":"{\"Commands\":[{\"SemanticQueryDataShapeCommand\":{\"Query\":{\"Version\":2,\"From\":[{\"Name\":\"c\",\"Entity\":\"cases_by_day\",\"Type\":0}],\"Select\":[{\"Column\":{\"Expression\":{\"SourceRef\":{\"Source\":\"c\"}},\"Property\":\"date_result\"},\"Name\":\"cases_by_day.date_result\"},{\"Aggregation\":{\"Expression\":{\"Column\":{\"Expression\":{\"SourceRef\":{\"Source\":\"c\"}},\"Property\":\"n\"}},\"Function\":0},\"Name\":\"CountNonNull(cases_by_day.n)\"}],\"Where\":[{\"Condition\":{\"In\":{\"Expressions\":[{\"Column\":{\"Expression\":{\"SourceRef\":{\"Source\":\"c\"}},\"Property\":\"yesterday_or_before\"}}],\"Values\":[[{\"Literal\":{\"Value\":\"1L\"}}],[{\"Literal\":{\"Value\":\"0L\"}}]]}}}]},\"Binding\":{\"Primary\":{\"Groupings\":[{\"Projections\":[0,1]}]},\"DataReduction\":{\"DataVolume\":4,\"Primary\":{\"Sample\":{}}},\"Version\":1}}}]}","QueryId":"","ApplicationContext":{"DatasetId":"aa4631ab-2f78-40f6-b4c4-d2f5f8a89bcc","Sources":[{"ReportId":"baf74baa-bdc9-4c71-995a-b996f1d0b7e9"}]}},{"Query":{"Commands":[{"SemanticQueryDataShapeCommand":{"Query":{"Version":2,"From":[{"Name":"c","Entity":"cases_by_day","Type":0}],"Select":[{"Column":{"Expression":{"SourceRef":{"Source":"c"}},"Property":"date_result"},"Name":"cases_by_day.date_result"},{"Measure":{"Expression":{"SourceRef":{"Source":"c"}},"Property":"Sum of n running total in date_result"},"Name":"cases_by_day.Sum of n running total in date_result"}],"Where":[{"Condition":{"In":{"Expressions":[{"Column":{"Expression":{"SourceRef":{"Source":"c"}},"Property":"yesterday_or_before"}}],"Values":[[{"Literal":{"Value":"1L"}}],[{"Literal":{"Value":"0L"}}]]}}}]},"Binding":{"Primary":{"Groupings":[{"Projections":[0,1]}]},"DataReduction":{"DataVolume":4,"Primary":{"Sample":{}}},"Version":1}}}]},"CacheKey":"{\"Commands\":[{\"SemanticQueryDataShapeCommand\":{\"Query\":{\"Version\":2,\"From\":[{\"Name\":\"c\",\"Entity\":\"cases_by_day\",\"Type\":0}],\"Select\":[{\"Column\":{\"Expression\":{\"SourceRef\":{\"Source\":\"c\"}},\"Property\":\"date_result\"},\"Name\":\"cases_by_day.date_result\"},{\"Measure\":{\"Expression\":{\"SourceRef\":{\"Source\":\"c\"}},\"Property\":\"Sum of n running total in date_result\"},\"Name\":\"cases_by_day.Sum of n running total in date_result\"}],\"Where\":[{\"Condition\":{\"In\":{\"Expressions\":[{\"Column\":{\"Expression\":{\"SourceRef\":{\"Source\":\"c\"}},\"Property\":\"yesterday_or_before\"}}],\"Values\":[[{\"Literal\":{\"Value\":\"1L\"}}],[{\"Literal\":{\"Value\":\"0L\"}}]]}}}]},\"Binding\":{\"Primary\":{\"Groupings\":[{\"Projections\":[0,1]}]},\"DataReduction\":{\"DataVolume\":4,\"Primary\":{\"Sample\":{}}},\"Version\":1}}}]}","QueryId":"","ApplicationContext":{"DatasetId":"aa4631ab-2f78-40f6-b4c4-d2f5f8a89bcc","Sources":[{"ReportId":"baf74baa-bdc9-4c71-995a-b996f1d0b7e9"}]}}],"cancelQueries":[],"modelId":275725}' > dashboard.json
jq '.results | map(.result.data | {key: (.descriptor.Select[] | select(.Value == "M0").Name), value: (.dsr.DS[].PH[].DM0 | map({date: ((.C[0] | . / 1000) | strftime("%Y-%m-%d")), cases: .C[1]}))}) | from_entries | {newCases: .["CountNonNull(cases_by_day.n)"], cases: .["cases_by_day.Sum of n running total in date_result"]} | .newCases = (.newCases | map({date: .date, newCases: .cases})) | map_values(INDEX(.date)) | [JOIN(.newCases; .cases[]; .date; add)] | [foreach .[] as $row (0; ($row.newCases // .); . as $x | $row | (.newCases = (.newCases // $x)))] | INDEX(.date)' dashboard.json > cases.json

# Fetch the hospitalizations by day from the dashboard
# Convert date from number of milliseconds to YYYY-MM-DD
# Fill in counts repeated from previous days, which are indicated by C = null, R = 2 or R = 4
curl 'https://wabi-us-gov-iowa-api.analysis.usgovcloudapi.net/public/reports/querydata' --compressed --data '{"version":"1.0.0","queries":[{"Query":{"Commands":[{"SemanticQueryDataShapeCommand":{"Query":{"Version":2,"From":[{"Name":"h","Entity":"hosp_daily_data","Type":0}],"Select":[{"Aggregation":{"Expression":{"Column":{"Expression":{"SourceRef":{"Source":"h"}},"Property":"vent_avail"}},"Function":0},"Name":"Sum(hosp_daily_data.vent_avail)"},{"Aggregation":{"Expression":{"Column":{"Expression":{"SourceRef":{"Source":"h"}},"Property":"vent_in_use"}},"Function":0},"Name":"Sum(hosp_daily_data.vent_in_use)"},{"Column":{"Expression":{"SourceRef":{"Source":"h"}},"Property":"real_date"},"Name":"hosp_daily_data.real_date"}],"Where":[{"Condition":{"Between":{"Expression":{"Column":{"Expression":{"SourceRef":{"Source":"h"}},"Property":"real_date"}},"LowerBound":{"DateSpan":{"Expression":{"DateAdd":{"Expression":{"DateAdd":{"Expression":{"Now":{}},"Amount":1,"TimeUnit":0}},"Amount":-9,"TimeUnit":0}},"TimeUnit":0}},"UpperBound":{"DateSpan":{"Expression":{"Now":{}},"TimeUnit":0}}}}}],"OrderBy":[{"Direction":1,"Expression":{"Column":{"Expression":{"SourceRef":{"Source":"h"}},"Property":"real_date"}}}]},"Binding":{"Primary":{"Groupings":[{"Projections":[0,1,2]}]},"DataReduction":{"DataVolume":4,"Primary":{"Window":{"Count":1000}}},"Version":1}}}]},"CacheKey":"{\"Commands\":[{\"SemanticQueryDataShapeCommand\":{\"Query\":{\"Version\":2,\"From\":[{\"Name\":\"h\",\"Entity\":\"hosp_daily_data\",\"Type\":0}],\"Select\":[{\"Aggregation\":{\"Expression\":{\"Column\":{\"Expression\":{\"SourceRef\":{\"Source\":\"h\"}},\"Property\":\"vent_avail\"}},\"Function\":0},\"Name\":\"Sum(hosp_daily_data.vent_avail)\"},{\"Aggregation\":{\"Expression\":{\"Column\":{\"Expression\":{\"SourceRef\":{\"Source\":\"h\"}},\"Property\":\"vent_in_use\"}},\"Function\":0},\"Name\":\"Sum(hosp_daily_data.vent_in_use)\"},{\"Column\":{\"Expression\":{\"SourceRef\":{\"Source\":\"h\"}},\"Property\":\"real_date\"},\"Name\":\"hosp_daily_data.real_date\"}],\"Where\":[{\"Condition\":{\"Between\":{\"Expression\":{\"Column\":{\"Expression\":{\"SourceRef\":{\"Source\":\"h\"}},\"Property\":\"real_date\"}},\"LowerBound\":{\"DateSpan\":{\"Expression\":{\"DateAdd\":{\"Expression\":{\"DateAdd\":{\"Expression\":{\"Now\":{}},\"Amount\":1,\"TimeUnit\":0}},\"Amount\":-9,\"TimeUnit\":0}},\"TimeUnit\":0}},\"UpperBound\":{\"DateSpan\":{\"Expression\":{\"Now\":{}},\"TimeUnit\":0}}}}}],\"OrderBy\":[{\"Direction\":1,\"Expression\":{\"Column\":{\"Expression\":{\"SourceRef\":{\"Source\":\"h\"}},\"Property\":\"real_date\"}}}]},\"Binding\":{\"Primary\":{\"Groupings\":[{\"Projections\":[0,1,2]}]},\"DataReduction\":{\"DataVolume\":4,\"Primary\":{\"Window\":{\"Count\":1000}}},\"Version\":1}}}]}","QueryId":"","ApplicationContext":{"DatasetId":"90391cf1-e578-44e6-a44b-d83d319d7576","Sources":[{"ReportId":"0ebf5112-7e64-46ec-9c6f-394b7dbc0a30"}]}}],"cancelQueries":[],"modelId":275730}' > dashboard.json
jq '.results[].result.data.dsr.DS[].PH[].DM0 | map({date: ((.C[0] | . / 1000) | strftime("%Y-%m-%d")), nonICU: .C[1], icu: .C[2]}) | [foreach .[] as $row (0; ($row.icu // .); . as $x | $row | (.icu = (.icu // $x)))] | [foreach .[] as $row (0; ($row.nonICU // .); . as $x | $row | (.nonICU = (.nonICU // $x)))] | INDEX(.date) | map_values(.hospitalized = .icu + .nonICU)' dashboard.json > hosp.json

# Fetch the dashboard's UI, which contains the death toll timestamp
curl 'https://wabi-us-gov-iowa-api.analysis.usgovcloudapi.net/public/reports/86dc380f-4914-4cff-b2a5-03af9f292bbd/modelsAndExploration?preferReadOnlySession=true' --compressed -H 'X-PowerBI-ResourceKey: 86dc380f-4914-4cff-b2a5-03af9f292bbd' > ui.json

# Isolate the death toll's timestamp
jq '.exploration.sections[].visualContainers[].config | match("Death data last updated (\\w+ \\d+, \\d+)").captures[0].string | strptime("%B %d, %Y") | strftime("%Y-%m-%d")' ui.json > death_date.json

# Fetch the death toll from the dashboard
curl 'https://wabi-us-gov-iowa-api.analysis.usgovcloudapi.net/public/reports/querydata' --compressed --data '{"version":"1.0.0","queries":[{"Query":{"Commands":[{"SemanticQueryDataShapeCommand":{"Query":{"Version":2,"From":[{"Name":"d1","Entity":"deaths by race","Type":0}],"Select":[{"Aggregation":{"Expression":{"Column":{"Expression":{"SourceRef":{"Source":"d1"}},"Property":"n"}},"Function":0},"Name":"Sum(deaths by race.n)"}]},"Binding":{"Primary":{"Groupings":[{"Projections":[0]}]},"DataReduction":{"DataVolume":3,"Primary":{"Top":{}}},"Version":1}}}]},"CacheKey":"{\"Commands\":[{\"SemanticQueryDataShapeCommand\":{\"Query\":{\"Version\":2,\"From\":[{\"Name\":\"d1\",\"Entity\":\"deaths by race\",\"Type\":0}],\"Select\":[{\"Aggregation\":{\"Expression\":{\"Column\":{\"Expression\":{\"SourceRef\":{\"Source\":\"d1\"}},\"Property\":\"n\"}},\"Function\":0},\"Name\":\"Sum(deaths by race.n)\"}]},\"Binding\":{\"Primary\":{\"Groupings\":[{\"Projections\":[0]}]},\"DataReduction\":{\"DataVolume\":3,\"Primary\":{\"Top\":{}}},\"Version\":1}}}]}","QueryId":"","ApplicationContext":{"DatasetId":"aa4631ab-2f78-40f6-b4c4-d2f5f8a89bcc","Sources":[{"ReportId":"baf74baa-bdc9-4c71-995a-b996f1d0b7e9"}]}}],"cancelQueries":[],"modelId":275725}' > dashboard.json
jq '.results[].result.data.dsr.DS[].PH[].DM0[].M0' dashboard.json > deaths.json

# Join cases with hospitalizations and deaths
# Backfill deaths and hospitalizations from Commons
# Update Commons
jq -s --tab '.[4] as $commons | ($commons.data | INDEX(.[0])) as $oldData | .[0][.[2]].deaths = .[3] | [JOIN(.[1]; .[0][]; .date; add) | [.date, .newCases, .cases, .deaths // $oldData[.date][3], .hospitalized // $oldData[.date][4]]] as $newData | $commons | .data = $newData' cases.json hosp.json death_date.json deaths.json commons.json | expand -t4
